<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="css/structurizr.css" rel="stylesheet" media="screen" />
    <style>
        html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
        #diagram { width: 100%; height: 100vh; }
    </style>

    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/jointjs-Core-4.1.3.js"></script>
    <script src="js/dagre-1.1.8.js"></script>
    <script src="js/graphlib-2.2.4.min.js"></script>
    <script src="js/jointjs-DirectedGraph-4.1.3.min.js"></script>

    <script src="js/structurizr.js"></script>
    <script src="js/structurizr-util.js"></script>
    <script src="js/structurizr-ui.js"></script>
    <script src="js/structurizr-workspace.js"></script>
    <script src="js/structurizr-diagram.js"></script>
</head>
<body>
<div id="diagram"></div>
</body>
</html>

<script>
    let diagram;
    const viewIndex = new Map();

    async function loadWorkspace() {
      const res = await fetch("https://raw.githubusercontent.com/structurizr/ui/main/examples/big-bank-plc.json");
      if (!res.ok) throw new Error(`Unable to load workspace: ${res.status} ${res.statusText}`);
      const data = await res.json();

      const viewMap = new Map();

      window.structurizr.workspace = new structurizr.Workspace(data);

      const buckets = [
        'systemLandscapeViews', 'systemContextViews', 'containerViews', 'componentViews',
        'dynamicViews', 'deploymentViews', 'filteredViews', 'customViews'
      ];
      const w = window.structurizr.workspace;
      for (const b of buckets) {
        for (const v of (w.views[b] || [])) {
            viewIndex.set(v.key, v);
            viewMap.set( v.key, v.title || v.name || v.key );
        }
      }

      structurizr.diagram = new structurizr.ui.Diagram('diagram', false, () => {
        const firstKey = [...viewIndex.keys()][0];
        if (firstKey) changeView(firstKey);
      });

      return Object.fromEntries(viewMap);
    }

    function changeView(key) {
      if (!structurizr.diagram) throw new Error('Diagram not initialized');
      structurizr.diagram.changeView(key);
    }

    function exportSvg() {
      const svgEl = document.querySelector('#diagram svg');
      if (!svgEl) return null;
      const clone = svgEl.cloneNode(true);
      let s = new XMLSerializer().serializeToString(clone);
      if (!/^<svg[^>]+xmlns=/.test(s)) {
        s = s.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
      }
      s = s.replace(/&nbsp;/g, '&#160;');
      if (!s.startsWith('<?xml')) {
        s = '<?xml version="1.0" encoding="UTF-8"?>\n' + s;
      }
      return s;
    }
</script>