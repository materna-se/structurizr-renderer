<!DOCTYPE html>
<html lang="en">
<head>
    <script src="js/jquery-3.6.3.min.js"></script>

    <script src="js/lodash-4.17.21.js"></script>
    <script src="js/backbone-1.4.1.js"></script>
    <script type="text/javascript" src="js/joint-3.6.5.js"></script>

    <script type="text/javascript" src="js/dagre-0.7.3.min.js"></script>
    <script type="text/javascript" src="js/graphlib-2.1.3.min.js"></script>
    <script type="text/javascript" src="js/structurizr.js"></script>
    <script type="text/javascript" src="js/structurizr-util.js"></script>
    <script type="text/javascript" src="js/structurizr-ui.js"></script>
    <script type="text/javascript" src="js/structurizr-workspace.js"></script>
    <script type="text/javascript" src="js/structurizr-diagram.js"></script>

    <link href="css/joint-3.6.5.css" rel="stylesheet" media="screen" />
    <link href="css/structurizr.css" rel="stylesheet" media="screen" />

    <style>
    body {
        font-family: Arial;
    }
    </style>
</head>
<body>
    <div id="diagram" style="width: 1000px; height: 600px;"></div>
</body>
</html>

<script>
    var diagram;
    var views;

    $.ajax({
        url: 'https://raw.githubusercontent.com/structurizr/ui/main/examples/big-bank-plc.json',
        dataType: 'json',
        success: function(data){
            structurizr.workspace = new structurizr.Workspace(data);

            diagram = new structurizr.ui.Diagram('diagram', false, function() {
                diagram.changeView('Containers');
            });
        }
    });

    function resolveViews() {
        const viewMap = new Map();
        views = new Map();
        const w = window.structurizr && window.structurizr.workspace;
        if (!w || !w.views) return viewMap;
        const buckets = [
            'systemLandscapeViews', 'systemContextViews', 'containerViews', 'componentViews',
            'dynamicViews', 'deploymentViews', 'filteredViews', 'customViews'
        ];
        for (const name of buckets) {
            const list = w.views[name] || [];
            for (const x of list) {
                views.set(x.key, x)
                viewMap.set( x.key, x.title || x.name || x.key );
            }
        }
        return Object.fromEntries(viewMap);
    }

    function changeView(k) {
        console.log("Changing view: " + k)

        const actualView = views.get(k)
        console.log("Actual views: " + JSON.stringify(actualView))
        if (actualView && actualView.automaticLayout) {
            console.log("Applying automatic layout")
            diagram.changeView(k, function () {
                    diagram.runDagre(
                        actualView.automaticLayout.rankDirection,
                        actualView.automaticLayout.rankSeparation,
                        actualView.automaticLayout.nodeSeparation,
                        actualView.automaticLayout.edgeSeparation,
                        actualView.automaticLayout.vertices,
                        true
                    );

                    diagram.autoPageSize();
                }
            )
        } else {
            diagram.changeView(k);
        }
    }

    function exportSvg() {
        const svgEl = document.querySelector('#diagram svg');
        if (!svgEl) return null;
        const clone = svgEl.cloneNode(true);
        const serializer = new XMLSerializer();
        let s = serializer.serializeToString(clone);
        // Namespace sicherstellen
        if (!/^<svg[^>]+xmlns=/.test(s)) {
          s = s.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
        }
        // HTML-Entitäten für XML korrigieren (nbsp → 160)
        s = s.replace(/&nbsp;/g, '&#160;');
        // XML-Prolog ergänzen
        if (!s.startsWith('<?xml')) {
          s = '<?xml version="1.0" encoding="UTF-8"?>\n' + s;
        }
        return s;
    }
</script>